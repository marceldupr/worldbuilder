import { describe, it, expect, beforeEach, afterEach, beforeAll } from 'vitest';
import request from 'supertest';
import { app } from '../../index';
import { PrismaClient } from '@prisma/client';

/**
 * Integration Tests for {{linkedElement}} API
 * Generated by Worldbuilder
 */

describe('{{linkedElement}} API', () => {
  let prisma: PrismaClient;
  let authToken: string;

  beforeAll(async () => {
    prisma = new PrismaClient();
    // TODO: Create test user and get auth token
    authToken = 'test-token';
  });

  afterAll(async () => {
    await prisma.$disconnect();
  });

  beforeEach(async () => {
    // Clean database before each test
    await prisma.{{camelCase linkedElement}}.deleteMany({});
  });

{{#if operations.create}}
  describe('POST {{kebabCase linkedElement}}', () => {
    it('should create {{camelCase linkedElement}} with authentication', async () => {
      const response = await request(app)
        .post('/{{kebabCase linkedElement}}')
        .set('Authorization', `Bearer ${authToken}`)
        .send({
          // TODO: Add valid test data based on schema
        })
        .expect(201);

      expect(response.body.id).toBeDefined();
    });

{{#if (eq ../authentication.create 'authenticated')}}
    it('should reject unauthenticated requests', async () => {
      await request(app)
        .post('/{{kebabCase linkedElement}}')
        .send({})
        .expect(401);
    });
{{/if}}

    it('should validate request body', async () => {
      const response = await request(app)
        .post('/{{kebabCase linkedElement}}')
        .set('Authorization', `Bearer ${authToken}`)
        .send({})
        .expect(400);

      expect(response.body.error).toBeDefined();
    });
  });
{{/if}}

{{#if operations.read}}
  describe('GET /{{kebabCase linkedElement}}', () => {
    it('should list all {{pluralize (camelCase linkedElement)}}', async () => {
      // Create test data
      await prisma.{{camelCase linkedElement}}.createMany({
        data: [
          { /* TODO: test data 1 */ },
          { /* TODO: test data 2 */ },
        ],
      });

      const response = await request(app)
        .get('/{{kebabCase linkedElement}}')
        .expect(200);

      expect(response.body.data).toHaveLength(2);
    });

    it('should support pagination', async () => {
      // Create 15 test records
      const testData = Array.from({ length: 15 }, (_, i) => ({
        // TODO: generate test data
      }));
      
      await prisma.{{camelCase linkedElement}}.createMany({ data: testData });

      const response = await request(app)
        .get('/{{kebabCase linkedElement}}?page=2&limit=10')
        .expect(200);

      expect(response.body.data).toHaveLength(5);
      expect(response.body.page).toBe(2);
    });
  });

  describe('GET /{{kebabCase linkedElement}}/:id', () => {
    it('should get single {{camelCase linkedElement}} by id', async () => {
      const created = await prisma.{{camelCase linkedElement}}.create({
        data: { /* TODO: test data */ },
      });

      const response = await request(app)
        .get(`/{{kebabCase linkedElement}}/${created.id}`)
        .expect(200);

      expect(response.body.id).toBe(created.id);
    });

    it('should return 404 for non-existent id', async () => {
      await request(app)
        .get('/{{kebabCase linkedElement}}/non-existent-id')
        .expect(404);
    });
  });
{{/if}}

{{#if operations.update}}
  describe('PATCH /{{kebabCase linkedElement}}/:id', () => {
    it('should update {{camelCase linkedElement}}', async () => {
      const created = await prisma.{{camelCase linkedElement}}.create({
        data: { /* TODO: test data */ },
      });

      const response = await request(app)
        .patch(`/{{kebabCase linkedElement}}/${created.id}`)
        .set('Authorization', `Bearer ${authToken}`)
        .send({ /* TODO: update data */ })
        .expect(200);

      expect(response.body.id).toBe(created.id);
    });

{{#if (eq ../authentication.update 'authenticated')}}
    it('should reject unauthenticated update requests', async () => {
      const created = await prisma.{{camelCase linkedElement}}.create({
        data: { /* TODO: test data */ },
      });

      await request(app)
        .patch(`/{{kebabCase linkedElement}}/${created.id}`)
        .send({})
        .expect(401);
    });
{{/if}}
  });
{{/if}}

{{#if operations.delete}}
  describe('DELETE /{{kebabCase linkedElement}}/:id', () => {
    it('should delete {{camelCase linkedElement}}', async () => {
      const created = await prisma.{{camelCase linkedElement}}.create({
        data: { /* TODO: test data */ },
      });

      await request(app)
        .delete(`/{{kebabCase linkedElement}}/${created.id}`)
        .set('Authorization', `Bearer ${authToken}`)
        .expect(204);

      const deleted = await prisma.{{camelCase linkedElement}}.findUnique({
        where: { id: created.id },
      });

      expect(deleted).toBeNull();
    });

{{#if (eq ../authentication.delete 'authenticated')}}
    it('should reject unauthenticated delete requests', async () => {
      const created = await prisma.{{camelCase linkedElement}}.create({
        data: { /* TODO: test data */ },
      });

      await request(app)
        .delete(`/{{kebabCase linkedElement}}/${created.id}`)
        .expect(401);
    });
{{/if}}
  });
{{/if}}

{{#if customEndpoints}}
{{#each customEndpoints}}
  describe('{{method}} {{path}}', () => {
    it('should handle custom endpoint: {{description}}', async () => {
      // TODO: Create test data
      const testData = {};
      
      const response = await request(app)
        .{{lowercase method}}('{{path}}')
{{#if (or (eq method 'POST') (eq method 'PATCH') (eq method 'PUT'))}}
        .send(testData)
{{/if}}
{{#unless (eq ../authentication.read 'public')}}
        .set('Authorization', `Bearer ${authToken}`)
{{/unless}}
        .expect(200);

      expect(response.body).toBeDefined();
    });

    it('should validate custom endpoint input', async () => {
      const response = await request(app)
        .{{lowercase method}}('{{path}}')
{{#if (or (eq method 'POST') (eq method 'PATCH') (eq method 'PUT'))}}
        .send({}) // Empty/invalid data
{{/if}}
{{#unless (eq ../authentication.read 'public')}}
        .set('Authorization', `Bearer ${authToken}`)
{{/unless}};

      // Depending on the endpoint, might return 200 or 400
      expect([200, 400]).toContain(response.status);
    });
  });

{{/each}}
{{/if}}
});

