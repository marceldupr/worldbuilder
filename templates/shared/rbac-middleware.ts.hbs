import { Request, Response, NextFunction } from 'express';

/**
 * Role-Based Access Control Middleware
 * Generated by Worldbuilder
 */

export interface AuthRequest extends Request {
  user?: {
    id: string;
    email?: string;
    role?: string;
  };
}

export type UserRole = 'admin' | 'manager' | 'user' | 'guest';

const roleHierarchy: Record<UserRole, number> = {
  admin: 4,
  manager: 3,
  user: 2,
  guest: 1,
};

/**
 * Check if user has required role or higher
 */
export function hasRole(userRole: string | undefined, requiredRole: UserRole): boolean {
  if (!userRole) return false;
  const userLevel = roleHierarchy[userRole as UserRole] || 0;
  const requiredLevel = roleHierarchy[requiredRole] || 0;
  return userLevel >= requiredLevel;
}

/**
 * Middleware: Require specific role
 */
export function requireRole(...roles: UserRole[]) {
  return (req: AuthRequest, res: Response, next: NextFunction) => {
    if (!req.user) {
      return res.status(401).json({ error: 'Authentication required' });
    }

    const userHasRole = roles.some((role) => hasRole(req.user?.role, role));

    if (!userHasRole) {
      return res.status(403).json({ 
        error: 'Insufficient permissions',
        required: roles,
        current: req.user.role || 'none',
      });
    }

    next();
  };
}

/**
 * Middleware: Require admin role
 */
export const requireAdmin = requireRole('admin');

/**
 * Middleware: Require manager or admin role  
 */
export const requireManager = requireRole('manager', 'admin');

/**
 * Middleware: Require authenticated user (any role)
 */
export const requireAuth = (req: AuthRequest, res: Response, next: NextFunction) => {
  if (!req.user) {
    return res.status(401).json({ error: 'Authentication required' });
  }
  next();
};

/**
 * Middleware: Resource ownership check
 */
export function requireOwnership(resourceIdParam: string = 'id') {
  return async (req: AuthRequest, res: Response, next: NextFunction) => {
    if (!req.user) {
      return res.status(401).json({ error: 'Authentication required' });
    }

    const resourceId = req.params[resourceIdParam];
    
    // Admins can access everything
    if (req.user.role === 'admin') {
      return next();
    }

    // TODO: Implement ownership check logic
    // Example: const resource = await prisma.resource.findUnique({ where: { id: resourceId } });
    // if (resource.userId !== req.user.id) return res.status(403)...

    next();
  };
}

