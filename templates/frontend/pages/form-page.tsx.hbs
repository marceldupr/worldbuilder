/**
 * {{pascalCase name}} Form Page (Create/Edit)
 * Generated by Worldbuilder
 */

import { useEffect } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import { useForm, Controller } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { z } from 'zod';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import {
  Box,
  Button,
  Paper,
  Typography,
  TextField,
  Grid,
  Alert,
  CircularProgress,
  FormControlLabel,
  Checkbox,
  MenuItem,
  Select,
  FormControl,
  InputLabel,
  FormHelperText,
} from '@mui/material';
import {
  ArrowBack as BackIcon,
  Save as SaveIcon,
} from '@mui/icons-material';
import { api, Create{{pascalCase name}}Input, Update{{pascalCase name}}Input } from '../lib/api-client';
import { RelationshipField } from '../components/RelationshipField';

// Validation schema
const {{camelCase name}}Schema = z.object({
  {{#each schema.properties}}
  {{#unless (or (eq name "id") (eq name "createdAt") (eq name "updatedAt"))}}
  {{camelCase name}}: z.{{zodType type}}(){{#if required}}.min(1, '{{titleCase name}} is required'){{/if}}{{#if validations.min}}.min({{validations.min}}){{/if}}{{#if validations.max}}.max({{validations.max}}){{/if}},
  {{/unless}}
  {{/each}}
  {{#each schema.relationships}}
  {{#if (eq type "belongsTo")}}
  {{camelCase fieldName}}Id: z.string(){{#if required}}.min(1, '{{titleCase to}} is required'){{/if}},
  {{/if}}
  {{/each}}
});

type FormData = z.infer<typeof {{camelCase name}}Schema>;

export function {{pascalCase name}}FormPage() {
  const { id } = useParams<{ id: string }>();
  const navigate = useNavigate();
  const queryClient = useQueryClient();
  const isEdit = !!id && id !== 'new';

  // Fetch existing data for edit
  const \{ data: existing \} = useQuery(\{
    queryKey: ['{{camelCase name}}', id],
    queryFn: () => api.{{camelCase name}}.getById(id!),
    enabled: isEdit,
  \});

  // Form
  const \{
    control,
    handleSubmit,
    reset,
    formState: \{ errors, isSubmitting \},
  \} = useForm<FormData>(\{
    resolver: zodResolver({{camelCase name}}Schema),
    defaultValues: {
      {{#each schema.properties}}
      {{#unless (or (eq name "id") (eq name "createdAt") (eq name "updatedAt"))}}
      {{camelCase name}}: {{#if (eq type "boolean")}}false{{else if (eq type "integer")}}0{{else}}''{{/if}},
      {{/unless}}
      {{/each}}
      {{#each schema.relationships}}
      {{#if (eq type "belongsTo")}}
      {{camelCase fieldName}}Id: '',
      {{/if}}
      {{/each}}
    \},
  \});

  // Reset form when data loads
  useEffect(() => {
    if (existing) {
      reset(existing);
    }
  }, [existing, reset]);

  // Create mutation
  const createMutation = useMutation(\{
    mutationFn: (data: Create{{pascalCase name}}Input) => api.{{camelCase name}}.create(data),
    onSuccess: () => \{
      queryClient.invalidateQueries(\{ queryKey: ['{{camelCase name}}'] \});
      navigate('/{{kebabCase name}}');
    \},
  \});

  // Update mutation
  const updateMutation = useMutation(\{
    mutationFn: (data: Update{{pascalCase name}}Input) => api.{{camelCase name}}.update(id!, data),
    onSuccess: () => \{
      queryClient.invalidateQueries(\{ queryKey: ['{{camelCase name}}'] \});
      navigate(`/{{kebabCase name}}/$\{id\}`);
    \},
  \});

  const onSubmit = async (data: FormData) => {
    try {
      if (isEdit) {
        await updateMutation.mutateAsync(data);
      } else {
        await createMutation.mutateAsync(data);
      }
    } catch (error: any) {
      console.error('Form submission error:', error);
    }
  };

  return (
    <Box p={3}>
      <Box display="flex" alignItems="center" gap={2} mb={3}>
        <Button
          variant="outlined"
          startIcon=\{<BackIcon />}
          onClick={() => navigate(isEdit ? `/{{kebabCase name}}/${id}` : '/{{kebabCase name}}')}
        >
          Back
        </Button>
        <Typography variant="h4">
          {isEdit ? 'Edit' : 'Create'} {{pascalCase name}}
        </Typography>
      </Box>

      {(createMutation.error || updateMutation.error) && (
        <Alert severity="error" sx=\{{ mb: 2 }}>
          {(createMutation.error as any)?.message || (updateMutation.error as any)?.message || 'An error occurred'}
        </Alert>
      )}

      <Paper sx=\{{ p: 3 }}>
        <form onSubmit={handleSubmit(onSubmit)}>
          <Grid container spacing={3}>
            {{#each schema.properties}}
            {{#unless (or (eq name "id") (eq name "createdAt") (eq name "updatedAt"))}}
            <Grid item xs={12} sm={6}>
              {{#if (eq type "boolean")}}
              <Controller
                name="{{camelCase name}}"
                control={control}
                render={({ field }) => (
                  <FormControlLabel
                    control=\{<Checkbox \{...field\} checked=\{field.value\} />\}
                    label="{{titleCase name}}"
                  />
                )}
              />
              {{else if (eq type "enum")}}
              <Controller
                name="{{camelCase name}}"
                control={control}
                render={({ field }) => (
                  <FormControl fullWidth error=\{!!errors.{{camelCase name}}\}>
                    <InputLabel>{{titleCase name}}</InputLabel>
                    <Select \{...field\} label="{{titleCase name}}">
                      {{#each validations.values}}
                      <MenuItem value="{{this}}">{{titleCase this}}</MenuItem>
                      {{/each}}
                    </Select>
                    <FormHelperText>\{errors.{{camelCase name}}?.message\}</FormHelperText>
                  </FormControl>
                )}
              />
              {{else if (eq type "text")}}
              <Controller
                name="{{camelCase name}}"
                control={control}
                render={({ field }) => (
                  <TextField
                    \{...field\}
                    label="{{titleCase name}}"
                    multiline
                    rows=\{4\}
                    fullWidth
                    error=\{!!errors.{{camelCase name}}\}
                    helperText=\{errors.{{camelCase name}}?.message\}
                  />
                )}
              />
              {{else}}
              <Controller
                name="{{camelCase name}}"
                control={control}
                render={({ field }) => (
                  <TextField
                    \{...field\}
                    label="{{titleCase name}}"
                    type="{{inputType type}}"
                    fullWidth
                    {{#if required}}required{{/if}}
                    error=\{!!errors.{{camelCase name}}\}
                    helperText=\{errors.{{camelCase name}}?.message\}
                  />
                )}
              />
              {{/if}}
            </Grid>
            {{/unless}}
            {{/each}}

            {{#each schema.relationships}}
            {{#if (eq type "belongsTo")}}
            <Grid item xs={12} sm={6}>
              <Controller
                name="{{camelCase fieldName}}Id"
                control={control}
                render={({ field }) => (
                  <RelationshipField
                    label="{{titleCase to}}"
                    value=\{field.value\}
                    onChange=\{field.onChange\}
                    relatedEntity="{{pascalCase to}}"
                    {{#if required}}required{{/if}}
                    error=\{errors.{{camelCase fieldName}}Id?.message\}
                  />
                )}
              />
            </Grid>
            {{/if}}
            {{/each}}

            <Grid item xs={12}>
              <Box display="flex" gap={2} justifyContent="flex-end">
                <Button
                  variant="outlined"
                  onClick={() => navigate(isEdit ? `/{{kebabCase name}}/${id}` : '/{{kebabCase name}}')}
                >
                  Cancel
                </Button>
                <Button
                  type="submit"
                  variant="contained"
                  startIcon=\{<SaveIcon />}
                  disabled=\{isSubmitting}
                >
                  \{isSubmitting ? <CircularProgress size=\{24\} /> : isEdit ? 'Update' : 'Create'\}
                </Button>
              </Box>
            </Grid>
          </Grid>
        </form>
      </Paper>
    </Box>
  );
}

