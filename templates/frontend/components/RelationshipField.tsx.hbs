/**
 * Relationship Field Component
 * Handles foreign key fields as dropdowns with related entity names
 * Generated by Worldbuilder
 */

import { useQuery } from '@tanstack/react-query';
import {
  FormControl,
  InputLabel,
  Select,
  MenuItem,
  FormHelperText,
  CircularProgress,
} from '@mui/material';
import { api } from '../lib/api-client';

interface RelationshipFieldProps {
  label: string;
  value: string | null;
  onChange: (value: string) => void;
  relatedEntity: string; // e.g., "Category", "User"
  required?: boolean;
  error?: string;
  disabled?: boolean;
}

export function RelationshipField({
  label,
  value,
  onChange,
  relatedEntity,
  required = false,
  error,
  disabled = false,
}: RelationshipFieldProps) {
  // Fetch options for the dropdown
  const { data: options, isLoading } = useQuery({
    queryKey: [relatedEntity.toLowerCase(), 'options'],
    queryFn: async () => {
      // Call the API to get all entities of this type
      const entityKey = relatedEntity.charAt(0).toLowerCase() + relatedEntity.slice(1);
      const response = await (api as any)[entityKey]?.getAll({ limit: 1000 });
      return response?.data || [];
    },
  });

  return (
    <FormControl fullWidth error={!!error} disabled={disabled}>
      <InputLabel required={required}>{label}</InputLabel>
      <Select
        value={value || ''}
        onChange={(e) => onChange(e.target.value)}
        label={label}
        disabled={isLoading || disabled}
      >
        {!required && (
          <MenuItem value="">
            <em>None</em>
          </MenuItem>
        )}
        {isLoading ? (
          <MenuItem disabled>
            <CircularProgress size={20} sx=\{{ mr: 1 }} />
            Loading...
          </MenuItem>
        ) : (
          options?.map((option: any) => (
            <MenuItem key={option.id} value={option.id}>
              {getDisplayName(option)}
            </MenuItem>
          ))
        )}
      </Select>
      {error && <FormHelperText>{error}</FormHelperText>}
    </FormControl>
  );
}

/**
 * Get display name from an entity object
 * Tries common name fields, falls back to ID
 */
function getDisplayName(entity: any): string {
  if (!entity) return 'Unknown';
  
  const nameFields = ['name', 'title', 'label', 'displayName', 'fullName', 'email', 'username'];
  for (const field of nameFields) {
    if (entity[field]) return entity[field];
  }
  
  return entity.id || 'Unknown';
}

