/**
 * Type-safe API Client
 * Generated by Worldbuilder
 */

import axios, { AxiosInstance, AxiosRequestConfig } from 'axios';

// Types
{{#each elements}}
export interface {{pascalCase name}} {
  id: string;
  {{#each schema.properties}}
  {{#unless (eq name "id")}}
  {{camelCase name}}{{#unless required}}?{{/unless}}: {{jsType type}};
  {{/unless}}
  {{/each}}
  createdAt: string;
  updatedAt: string;
}

export interface Create{{pascalCase name}}Input {
  {{#each schema.properties}}
  {{#unless (or (eq name "id") (eq name "createdAt") (eq name "updatedAt"))}}
  {{camelCase name}}{{#unless required}}?{{/unless}}: {{jsType type}};
  {{/unless}}
  {{/each}}
}

export interface Update{{pascalCase name}}Input {
  {{#each schema.properties}}
  {{#unless (or (eq name "id") (eq name "createdAt") (eq name "updatedAt"))}}
  {{camelCase name}}?: {{jsType type}};
  {{/unless}}
  {{/each}}
}

{{/each}}

// Pagination
export interface PaginatedResponse<T> {
  data: T[];
  pagination: {
    page: number;
    limit: number;
    total: number;
    pages: number;
  };
}

// API Client Class
class ApiClient {
  private client: AxiosInstance;

  constructor(baseURL: string = import.meta.env.VITE_API_URL || 'http://localhost:3001') {
    this.client = axios.create({
      baseURL,
      headers: {
        'Content-Type': 'application/json',
      },
    });

    // Add auth token to requests
    this.client.interceptors.request.use((config) => {
      const token = localStorage.getItem('auth_token');
      if (token) {
        config.headers.Authorization = `Bearer ${token}`;
      }
      return config;
    });

    // Handle auth errors
    this.client.interceptors.response.use(
      (response) => response,
      (error) => {
        if (error.response?.status === 401) {
          localStorage.removeItem('auth_token');
          window.location.href = '/login';
        }
        return Promise.reject(error);
      }
    );
  }

  {{#each elements}}
  {{#if (hasManipulator name ../manipulators)}}
  // {{pascalCase name}} API
  {{camelCase name}} = {
    getAll: async (params?: { page?: number; limit?: number; include?: boolean }): Promise<PaginatedResponse<{{pascalCase name}}>> => {
      const response = await this.client.get('/{{kebabCase name}}', { 
        params: {
          ...params,
          include: params?.include !== false, // Default to true
        }
      });
      return response.data;
    },

    getById: async (id: string, include: boolean = true): Promise<{{pascalCase name}}> => {
      const response = await this.client.get(`/{{kebabCase name}}/${id}`, {
        params: { include }
      });
      return response.data;
    },

    create: async (data: Create{{pascalCase name}}Input): Promise<{{pascalCase name}}> => {
      const response = await this.client.post('/{{kebabCase name}}', data);
      return response.data;
    },

    update: async (id: string, data: Update{{pascalCase name}}Input): Promise<{{pascalCase name}}> => {
      const response = await this.client.patch(`/{{kebabCase name}}/${id}`, data);
      return response.data;
    },

    delete: async (id: string): Promise<void> => {
      await this.client.delete(`/{{kebabCase name}}/${id}`);
    },

    {{#if schema.relationships}}
    // Relationship helpers
    {{#each schema.relationships}}
    {{#if (eq type "belongsTo")}}
    getWith{{pascalCase to}}: async (id: string): Promise<{{pascalCase ../name}} & { {{camelCase fieldName}}: any }> => {
      const response = await this.client.get(`/{{kebabCase ../name}}/${id}`, {
        params: { include: true }
      });
      return response.data;
    },
    {{/if}}
    {{/each}}

    // Get all {{pluralize (pascalCase to)}} for dropdowns
    {{#each schema.relationships}}
    {{#if (eq type "belongsTo")}}
    getAvailable{{pluralize (pascalCase to)}}: async (): Promise<{ id: string; name: string }[]> => {
      const response = await this.client.get('/{{kebabCase to}}', {
        params: { limit: 1000, fields: 'id,name' }
      });
      return response.data.data;
    },
    {{/if}}
    {{/each}}
    {{/if}}
  };

  {{/if}}
  {{/each}}

  // Generic request method
  async request<T>(config: AxiosRequestConfig): Promise<T> {
    const response = await this.client.request<T>(config);
    return response.data;
  }
}

// Export singleton instance
export const api = new ApiClient();

