import { describe, it, expect, beforeEach, afterEach } from 'vitest';
import { PrismaClient } from '@prisma/client';
import { {{pascalCase name}}Service } from '../{{kebabCase name}}.service';
import { Create{{pascalCase name}}Dto, Update{{pascalCase name}}Dto } from '../{{kebabCase name}}.entity';

/**
 * Unit Tests for {{pascalCase name}} Service
 * Generated by Worldbuilder
 * 
 * {{#if description}}{{description}}{{/if}}
 */

describe('{{pascalCase name}} Service', () => {
  let prisma: PrismaClient;
  let service: {{pascalCase name}}Service;
  const testUserId = 'test-user-id';

  beforeEach(async () => {
    prisma = new PrismaClient();
    service = new {{pascalCase name}}Service(prisma);
    
    // Clean up test data
    await prisma.{{camelCase name}}.deleteMany({});
  });

  afterEach(async () => {
    await prisma.$disconnect();
  });

  describe('create', () => {
    it('should create {{camelCase name}} with valid data', async () => {
      const createDto: Create{{pascalCase name}}Dto = {
{{#each properties}}
{{#unless (or (eq name 'id') (eq name 'createdAt') (eq name 'updatedAt'))}}
        {{camelCase name}}: {{#if (eq type 'string')}}'Test {{pascalCase name}}'{{else if (eq type 'integer')}}10{{else if (eq type 'decimal')}}19.99{{else if (eq type 'boolean')}}true{{else if (eq type 'date')}}new Date(){{else if (eq type 'uuid')}}'test-uuid'{{else if (eq type 'enum')}}'{{default}}'{{else}}null{{/if}},
{{/unless}}
{{/each}}
      };

      const result = await service.create(createDto, testUserId);

      expect(result.id).toBeDefined();
{{#each properties}}
{{#unless (or (eq name 'id') (eq name 'createdAt') (eq name 'updatedAt'))}}
      expect(result.{{camelCase name}}).toBe(createDto.{{camelCase name}});
{{/unless}}
{{/each}}
    });

{{#each properties}}
{{#if required}}
{{#unless (or (eq name 'id') (eq name 'createdAt') (eq name 'updatedAt'))}}
    it('should reject missing {{camelCase name}}', async () => {
      const invalidDto: any = {
{{#each ../properties}}
{{#unless (or (eq name 'id') (eq name 'createdAt') (eq name 'updatedAt') (eq name @root.name))}}
        {{camelCase name}}: {{#if (eq type 'string')}}'Test'{{else if (eq type 'integer')}}10{{else if (eq type 'decimal')}}19.99{{else if (eq type 'boolean')}}true{{else if (eq type 'date')}}new Date(){{else}}null{{/if}},
{{/unless}}
{{/each}}
      };

      await expect(
        service.create(invalidDto, testUserId)
      ).rejects.toThrow();
    });

{{/unless}}
{{/if}}
{{/each}}
{{#each properties}}
{{#if (eq type 'integer')}}
{{#if min}}
    it('should reject {{camelCase name}} below minimum value', async () => {
      const invalidDto: Create{{pascalCase ../name}}Dto = {
{{#each ../properties}}
{{#unless (or (eq name 'id') (eq name 'createdAt') (eq name 'updatedAt'))}}
        {{camelCase name}}: {{#if (eq name @root.name)}}{{subtract min 1}}{{else if (eq type 'string')}}'Test'{{else if (eq type 'integer')}}10{{else if (eq type 'decimal')}}19.99{{else if (eq type 'boolean')}}true{{else if (eq type 'date')}}new Date(){{else}}null{{/if}},
{{/unless}}
{{/each}}
      };

      await expect(
        service.create(invalidDto, testUserId)
      ).rejects.toThrow();
    });

{{/if}}
{{/if}}
{{#if (eq type 'decimal')}}
{{#if min}}
    it('should reject negative {{camelCase name}}', async () => {
      const invalidDto: any = {
{{#each ../properties}}
{{#unless (or (eq name 'id') (eq name 'createdAt') (eq name 'updatedAt'))}}
        {{camelCase name}}: {{#if (eq name @root.name)}}-1{{else if (eq type 'string')}}'Test'{{else if (eq type 'integer')}}10{{else if (eq type 'decimal')}}19.99{{else if (eq type 'boolean')}}true{{else if (eq type 'date')}}new Date(){{else}}null{{/if}},
{{/unless}}
{{/each}}
      };

      await expect(
        service.create(invalidDto, testUserId)
      ).rejects.toThrow();
    });

{{/if}}
{{/if}}
{{/each}}
{{#each properties}}
{{#if default}}
    it('should default {{camelCase name}} to {{default}}', async () => {
      const createDto: any = {
{{#each ../properties}}
{{#unless (or (eq name 'id') (eq name 'createdAt') (eq name 'updatedAt') (eq name @root.name))}}
        {{camelCase name}}: {{#if (eq type 'string')}}'Test'{{else if (eq type 'integer')}}10{{else if (eq type 'decimal')}}19.99{{else if (eq type 'boolean')}}true{{else if (eq type 'date')}}new Date(){{else}}null{{/if}},
{{/unless}}
{{/each}}
      };

      const result = await service.create(createDto, testUserId);
      expect(result.{{camelCase name}}).toBe('{{default}}');
    });

{{/if}}
{{/each}}
  });

  describe('findById', () => {
    it('should find existing {{camelCase name}}', async () => {
      const created = await service.create({
{{#each properties}}
{{#unless (or (eq name 'id') (eq name 'createdAt') (eq name 'updatedAt'))}}
        {{camelCase name}}: {{#if (eq type 'string')}}'Test {{pascalCase name}}'{{else if (eq type 'integer')}}10{{else if (eq type 'decimal')}}19.99{{else if (eq type 'boolean')}}true{{else if (eq type 'date')}}new Date(){{else if (eq type 'uuid')}}'test-uuid'{{else if (eq type 'enum')}}'{{default}}'{{else}}null{{/if}},
{{/unless}}
{{/each}}
      }, testUserId);

      const found = await service.findById(created.id);

      expect(found).not.toBeNull();
      expect(found?.id).toBe(created.id);
    });

    it('should return null for non-existent {{camelCase name}}', async () => {
      const found = await service.findById('non-existent-id');
      expect(found).toBeNull();
    });
  });

  describe('update', () => {
    it('should update {{camelCase name}}', async () => {
      const created = await service.create({
{{#each properties}}
{{#unless (or (eq name 'id') (eq name 'createdAt') (eq name 'updatedAt'))}}
        {{camelCase name}}: {{#if (eq type 'string')}}'Original'{{else if (eq type 'integer')}}10{{else if (eq type 'decimal')}}19.99{{else if (eq type 'boolean')}}true{{else if (eq type 'date')}}new Date(){{else if (eq type 'uuid')}}'test-uuid'{{else if (eq type 'enum')}}'{{default}}'{{else}}null{{/if}},
{{/unless}}
{{/each}}
      }, testUserId);

      const updateDto: Update{{pascalCase name}}Dto = {
{{#each properties}}
{{#unless (or (eq name 'id') (eq name 'createdAt') (eq name 'updatedAt'))}}
{{#if @first}}
        {{camelCase name}}: {{#if (eq type 'string')}}'Updated'{{else if (eq type 'integer')}}20{{else if (eq type 'decimal')}}29.99{{else if (eq type 'boolean')}}false{{else if (eq type 'date')}}new Date(){{else}}null{{/if}},
{{/if}}
{{/unless}}
{{/each}}
      };

      const updated = await service.update(created.id, updateDto, testUserId);

{{#each properties}}
{{#unless (or (eq name 'id') (eq name 'createdAt') (eq name 'updatedAt'))}}
{{#if @first}}
      expect(updated.{{camelCase name}}).toBe(updateDto.{{camelCase name}});
{{/if}}
{{/unless}}
{{/each}}
    });

    it('should throw error for non-existent {{camelCase name}}', async () => {
      await expect(
        service.update('non-existent-id', {}, testUserId)
      ).rejects.toThrow('{{pascalCase name}} not found');
    });
  });

  describe('delete', () => {
    it('should delete {{camelCase name}}', async () => {
      const created = await service.create({
{{#each properties}}
{{#unless (or (eq name 'id') (eq name 'createdAt') (eq name 'updatedAt'))}}
        {{camelCase name}}: {{#if (eq type 'string')}}'Test'{{else if (eq type 'integer')}}10{{else if (eq type 'decimal')}}19.99{{else if (eq type 'boolean')}}true{{else if (eq type 'date')}}new Date(){{else if (eq type 'uuid')}}'test-uuid'{{else if (eq type 'enum')}}'{{default}}'{{else}}null{{/if}},
{{/unless}}
{{/each}}
      }, testUserId);

      await service.delete(created.id, testUserId);

      const found = await service.findById(created.id);
      expect(found).toBeNull();
    });

    it('should throw error for non-existent {{camelCase name}}', async () => {
      await expect(
        service.delete('non-existent-id', testUserId)
      ).rejects.toThrow('{{pascalCase name}} not found');
    });
  });

  describe('findAll', () => {
    it('should return empty array when no {{pluralize (camelCase name)}} exist', async () => {
      const result = await service.findAll({});
      expect(result).toHaveLength(0);
    });

    it('should return all {{pluralize (camelCase name)}}', async () => {
      await service.create({
{{#each properties}}
{{#unless (or (eq name 'id') (eq name 'createdAt') (eq name 'updatedAt'))}}
        {{camelCase name}}: {{#if (eq type 'string')}}'Test 1'{{else if (eq type 'integer')}}10{{else if (eq type 'decimal')}}19.99{{else if (eq type 'boolean')}}true{{else if (eq type 'date')}}new Date(){{else if (eq type 'uuid')}}'test-uuid-1'{{else if (eq type 'enum')}}'{{default}}'{{else}}null{{/if}},
{{/unless}}
{{/each}}
      }, testUserId);

      await service.create({
{{#each properties}}
{{#unless (or (eq name 'id') (eq name 'createdAt') (eq name 'updatedAt'))}}
        {{camelCase name}}: {{#if (eq type 'string')}}'Test 2'{{else if (eq type 'integer')}}20{{else if (eq type 'decimal')}}29.99{{else if (eq type 'boolean')}}false{{else if (eq type 'date')}}new Date(){{else if (eq type 'uuid')}}'test-uuid-2'{{else if (eq type 'enum')}}'{{default}}'{{else}}null{{/if}},
{{/unless}}
{{/each}}
      }, testUserId);

      const result = await service.findAll({});
      expect(result).toHaveLength(2);
    });
  });
});

